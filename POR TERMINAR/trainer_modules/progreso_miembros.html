```html
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Progreso | GymApp</title>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/icon.png') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_progreso_miembros.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="d-flex flex-column min-vh-100 bg-dark-purple">
{% include 'navbar.html' %}
<main class="container mt-4 flex-grow-1">
<h2 class="mb-4 text-center blog-intro">Progreso Miembros</h2>
<div class="d-flex gap-2 mb-3 flex-wrap">
<input type="text" id="buscarMiembro" class="form-control" placeholder="Buscar por nombre del miembro">
<select id="filtroDisciplina" class="form-select w-auto">
<option value="Todos">Todas las disciplinas</option>
<option value="Yoga">Yoga</option>
<option value="Crossfit">Crossfit</option>
<option value="Spinning">Spinning</option>
</select>
<select id="filtroEntrenador" class="form-select w-auto">
<option value="Todos">Todos los entrenadores</option>
</select>
<button id="actualizarProgreso" class="btn btn-primary">Actualizar Progreso</button>
</div>
<div class="table-responsive">
<table class="table table-bordered align-middle text-center">
<thead>
<tr>
<th>Nombre Miembro</th>
<th>Última Sesión</th>
<th>Peso (kg)</th>
<th>IMC</th>
<th>Calorías Quemadas</th>
<th>Metas Alcanzadas</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaProgreso"></tbody>
</table>
</div>
<nav>
<ul id="pagination" class="pagination justify-content-center"></ul>
</nav>
</main>
<div id="toastContainer" class="position-fixed p-3 top-0 end-0"></div>
<div class="modal fade" id="modalMetricas" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content bg-light">
<div class="modal-header">
<h5 class="modal-title">Registrar Métricas</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="formMetricas">
<input type="hidden" id="miembroId">
<div class="row mb-2">
<div class="col">
<label>Peso (kg)</label>
<input type="number" step="0.1" id="peso" class="form-control" required>
</div>
<div class="col">
<label>IMC</label>
<input type="number" step="0.1" id="imc" class="form-control" required>
</div>
<div class="col">
<label>Calorías Quemadas</label>
<input type="number" id="calorias" class="form-control" required>
</div>
</div>
<div class="mb-2">
<label>Observaciones</label>
<textarea id="observaciones" class="form-control" rows="2"></textarea>
</div>
<button type="submit" class="btn btn-success">Guardar Métricas</button>
</form>
</div>
</div>
</div>
</div>
<div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-xl">
<div class="modal-content bg-light">
<div class="modal-header">
<h5 class="modal-title">Detalle de Progreso</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<canvas id="chartProgreso" height="150"></canvas>
</div>
</div>
</div>
</div>
{% include 'footer.html' %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", ()=>{
const tabla=document.getElementById("tablaProgreso");
const buscar=document.getElementById("buscarMiembro");
const filtroDisciplina=document.getElementById("filtroDisciplina");
const filtroEntrenador=document.getElementById("filtroEntrenador");
const btnActualizar=document.getElementById("actualizarProgreso");
const toastContainer=document.getElementById("toastContainer");
const modalMetricas=new bootstrap.Modal(document.getElementById("modalMetricas"));
const modalDetalle=new bootstrap.Modal(document.getElementById("modalDetalle"));
let chart;

function mostrarToast(msg,tipo="success"){
const color=tipo==="error"?"bg-danger":"bg-success";
const toast=document.createElement("div");
toast.className=`toast align-items-center text-white ${color} border-0 show`;
toast.role="alert";
toast.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
toastContainer.appendChild(toast);
setTimeout(()=>toast.remove(),3000);
}

async function cargarProgreso(){
try{
const res=await fetch("/miembros_progreso");
const data=await res.json();
if(!data.ok) throw new Error();
renderProgreso(data.miembros);
if(filtroEntrenador.options.length<=1){
const entrenadores=[...new Set(data.miembros.map(m=>m.entrenador))];
entrenadores.forEach(e=>{
const opt=document.createElement("option");
opt.value=e;
opt.textContent=e;
filtroEntrenador.appendChild(opt);
});
}
}catch{
mostrarToast("Error al cargar progreso","error");
}
}

function renderProgreso(miembros){
tabla.innerHTML="";
const filtroTexto=buscar.value.toLowerCase();
const disciplinaSel=filtroDisciplina.value;
const entrenadorSel=filtroEntrenador.value;
const filtrados=miembros.filter(m=>{
const coincideNombre=m.nombre.toLowerCase().includes(filtroTexto);
const coincideDisciplina=disciplinaSel==="Todos"||m.disciplina===disciplinaSel;
const coincideEntrenador=entrenadorSel==="Todos"||m.entrenador===entrenadorSel;
return coincideNombre && coincideDisciplina && coincideEntrenador;
});
if(filtrados.length===0){
tabla.innerHTML=`<tr><td colspan="7">No hay miembros disponibles</td></tr>`;
return;
}
filtrados.forEach(m=>{
const tr=document.createElement("tr");
tr.innerHTML=`
<td>${m.nombre}</td>
<td>${m.ultima_sesion}</td>
<td>${m.peso}</td>
<td>${m.imc}</td>
<td>${m.calorias}</td>
<td>${m.metas_alcanzadas}</td>
<td>
<button class="btn btn-info btn-sm" onclick="verDetalle('${m.id}')"><i class="bi bi-graph-up"></i></button>
<button class="btn btn-success btn-sm" onclick="registrarMetricas('${m.id}')"><i class="bi bi-plus-circle"></i></button>
</td>`;
tabla.appendChild(tr);
});
}

window.verDetalle=async function(id){
try{
const res=await fetch(`/miembro_detalle/${id}`);
const data=await res.json();
if(!data.ok) throw new Error();
const ctx=document.getElementById("chartProgreso").getContext("2d");
if(chart) chart.destroy();
chart=new Chart(ctx,{
type:"line",
data:{
labels:data.historial.map(h=>h.fecha),
datasets:[
{label:"Peso (kg)", data:data.historial.map(h=>h.peso), borderColor:"blue", fill:false},
{label:"Calorías Quemadas", data:data.historial.map(h=>h.calorias), borderColor:"red", fill:false},
{label:"IMC", data:data.historial.map(h=>h.imc), borderColor:"green", fill:false}
]
},
options:{responsive:true, maintainAspectRatio:false}
});
modalDetalle.show();
}catch{
mostrarToast("Error al cargar detalle","error");
}
}

window.registrarMetricas=function(id){
document.getElementById("miembroId").value=id;
document.getElementById("peso").value="";
document.getElementById("imc").value="";
document.getElementById("calorias").value="";
document.getElementById("observaciones").value="";
modalMetricas.show();
}

document.getElementById("formMetricas").addEventListener("submit",async e=>{
e.preventDefault();
const payload={
id:document.getElementById("miembroId").value,
peso:document.getElementById("peso").value,
imc:document.getElementById("imc").value,
calorias:document.getElementById("calorias").value,
observaciones:document.getElementById("observaciones").value
};
try{
const res=await fetch("/registrar_metricas",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(payload)
});
const data=await res.json();
if(data.ok){
mostrarToast("Métricas registradas correctamente");
modalMetricas.hide();
cargarProgreso();
}else mostrarToast("Error al registrar métricas","error");
}catch{
mostrarToast("Error de conexión","error");
}
})

buscar.addEventListener("input",cargarProgreso);
filtroDisciplina.addEventListener("change",cargarProgreso);
filtroEntrenador.addEventListener("change",cargarProgreso);
btnActualizar.addEventListener("click",cargarProgreso);
cargarProgreso();
});
</script>
</body>
</html>
```
