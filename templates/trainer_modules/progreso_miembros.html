<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Progreso | GymApp</title>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/icon.png') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_progreso_miembros.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="d-flex flex-column min-vh-100 bg-dark-purple">
{% include 'navbar.html' %}

<main class="container mt-4 flex-grow-1">
<h2 class="mb-4 text-center blog-intro">Progreso Miembros</h2>

<div class="d-flex gap-2 mb-3 flex-wrap">
<input type="text" id="buscarMiembro" class="form-control" placeholder="Buscar por nombre del miembro">
<select id="filtroDisciplina" class="form-select w-auto">
<option value="Todos">Todas las disciplinas</option>
<option value="Yoga">Yoga</option>
<option value="Crossfit">Crossfit</option>
<option value="Spinning">Spinning</option>
</select>
<select id="filtroEntrenador" class="form-select w-auto">
<option value="Todos">Todos los entrenadores</option>
</select>
<button id="actualizarProgreso" class="btn btn-primary">Actualizar Progreso</button>
</div>

<div class="table-responsive">
<table class="table table-bordered align-middle text-center table-hover">
<thead class="table-dark">
<tr>
<th>Nombre Miembro</th>
<th>Entrenador</th>
<th>Última Sesión</th>
<th>Peso (kg)</th>
<th>Calorías Quemadas</th>
<th>Metas Alcanzadas</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaProgreso"></tbody>
</table>
</div>

<nav>
<ul id="pagination" class="pagination justify-content-center"></ul>
</nav>
</main>

<div id="toastContainer" class="position-fixed p-3 top-0 end-0"></div>

<div class="modal fade" id="modalMetricas" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content bg-light">
<div class="modal-header">
<h5 class="modal-title">Registrar Métricas</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="formMetricas">
<input type="hidden" id="miembroId">
<div class="row mb-3">
<div class="col">
<label>Peso (kg)</label>
<input type="number" step="0.1" id="peso" class="form-control" required>
</div>
<div class="col">
<label>Calorías Quemadas</label>
<input type="number" id="calorias" class="form-control" required>
</div>
</div>
<div class="row mb-3">
<div class="col">
<label>Fuerza</label>
<input type="number" step="0.1" id="fuerza" class="form-control">
</div>
<div class="col">
<label>Resistencia</label>
<input type="number" step="0.1" id="resistencia" class="form-control">
</div>
<div class="col">
<label>Masa Muscular</label>
<input type="number" step="0.1" id="masa_muscular" class="form-control">
</div>
</div>
<div class="row mb-3">
<div class="col">
<label>Grasa Corporal</label>
<input type="number" step="0.1" id="grasa_corporal" class="form-control">
</div>
</div>
<div class="mb-3">
<label>Observaciones</label>
<textarea id="observaciones" class="form-control" rows="2" placeholder="Notas adicionales"></textarea>
</div>
<div class="mb-3">
<label>Objetivo Personal</label>
<input type="text" id="objetivo" class="form-control" placeholder="Objetivo Personal">
</div>
<div class="d-flex justify-content-end gap-2">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="submit" class="btn btn-success">Guardar Métricas</button>
</div>
</form>
</div>
</div>
</div>
</div>

<div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-xl">
<div class="modal-content bg-light">
<div class="modal-header">
<h5 class="modal-title">Detalle de Progreso</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="row">
<div class="col-md-6">
<canvas id="chartProgresoPeso" height="150"></canvas>
</div>
<div class="col-md-6">
<canvas id="chartProgresoCalorias" height="150"></canvas>
</div>
</div>
<div class="mt-3">
<h6>Metas Alcanzadas</h6>
<ul id="listaMetas" class="list-group list-group-flush"></ul>
</div>
</div>
</div>
</div>
</div>

{% include 'footer.html' %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
    cargarMiembros();
    document.getElementById("formMetricas").addEventListener("submit", registrarMetricas);
    document.getElementById("actualizarProgreso").addEventListener("click", cargarMiembros);
    document.getElementById("buscarMiembro").addEventListener("input", filtrarTabla);
    document.getElementById("filtroDisciplina").addEventListener("change", filtrarTabla);
    document.getElementById("filtroEntrenador").addEventListener("change", filtrarTabla);
});

let miembros = [];

async function cargarMiembros(){
    const res = await fetch("/miembros_progreso");
    const data = await res.json();
    if(data.ok){
        miembros = data.miembros;
        renderTabla(miembros);
        cargarEntrenadores();
    }
}

function renderTabla(lista){
    const tabla = document.getElementById("tablaProgreso");
    tabla.innerHTML = "";
    lista.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${m.nombre}</td>
            <td>${m.entrenador}</td>
            <td>${m.ultima_sesion}</td>
            <td>${m.peso}</td>
            <td>${m.calorias}</td>
            <td>${m.objetivo_personal}</td>
            <td>
                <button class="btn btn-sm btn-success btn-registrar" data-id="${m.id}">Registrar</button>
                <button class="btn btn-sm btn-primary btn-detalle" data-id="${m.id}">Detalle</button>
            </td>
        `;
        tabla.appendChild(tr);
    });

    document.querySelectorAll(".btn-registrar").forEach(btn => {
        btn.addEventListener("click", e => {
            document.getElementById("miembroId").value = e.target.dataset.id;
            new bootstrap.Modal(document.getElementById("modalMetricas")).show();
        });
    });

    document.querySelectorAll(".btn-detalle").forEach(btn => {
        btn.addEventListener("click", e => {
            cargarDetalle(e.target.dataset.id);
        });
    });
}

async function cargarDetalle(id){
    const res = await fetch(`/miembro_detalle/${id}`);
    const data = await res.json();
    if(data.ok){
        const ctxPeso = document.getElementById("chartProgresoPeso").getContext("2d");
        const ctxCal = document.getElementById("chartProgresoCalorias").getContext("2d");
        new Chart(ctxPeso,{type:'line',data:{labels:data.historial.map(h=>h.fecha),datasets:[{label:'Peso',data:data.historial.map(h=>h.peso),borderColor:'blue',fill:false}]}}); 
        new Chart(ctxCal,{type:'line',data:{labels:data.historial.map(h=>h.fecha),datasets:[{label:'Calorías',data:data.historial.map(h=>h.calorias),borderColor:'red',fill:false}]}}); 
        const listaMetas = document.getElementById("listaMetas");
        listaMetas.innerHTML = data.historial.map(h=>`<li class="list-group-item">${h.objetivo_personal || ''}</li>`).join('');
        new bootstrap.Modal(document.getElementById("modalDetalle")).show();
    }
}

async function registrarMetricas(e){
    e.preventDefault();
    const payload = {
        id: document.getElementById("miembroId").value,
        peso: document.getElementById("peso").value,
        calorias: document.getElementById("calorias").value,
        fuerza: document.getElementById("fuerza").value,
        resistencia: document.getElementById("resistencia").value,
        masa_muscular: document.getElementById("masa_muscular").value,
        grasa_corporal: document.getElementById("grasa_corporal").value,
        observaciones: document.getElementById("observaciones").value,
        objetivo: document.getElementById("objetivo").value
    };
    await fetch("/registrar_metricas",{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
    });
    document.getElementById("formMetricas").reset();
    cargarMiembros();
    bootstrap.Modal.getInstance(document.getElementById("modalMetricas")).hide();
}

function filtrarTabla(){
    const filtroNombre = document.getElementById("buscarMiembro").value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    const filtroDisc = document.getElementById("filtroDisciplina").value;
    const filtroEntr = document.getElementById("filtroEntrenador").value;
    const filtrados = miembros.filter(m => {
        const nombreCompleto = (m.nombre || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        return nombreCompleto.includes(filtroNombre) &&
               (filtroDisc === "Todos" || m.disciplina === filtroDisc) &&
               (filtroEntr === "Todos" || m.entrenador === filtroEntr);
    });
    renderTabla(filtrados);
}

async function cargarEntrenadores(){
    const res = await fetch("/entrenadores");
    const data = await res.json();
    const select = document.getElementById("filtroEntrenador");
    select.innerHTML = '<option value="Todos">Todos los entrenadores</option>';
    if(data.ok){
        data.entrenadores.forEach(e=>{
            select.innerHTML += `<option value="${e.nombre}">${e.nombre}</option>`;
        });
    }
}

</script>
</body>
</html>
