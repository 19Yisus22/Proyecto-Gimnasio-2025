{% include 'navbar.html' %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfil del Usuario</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/icon.png') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_mi_perfil.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
body, html { height:100%; margin:0; background:#1c1c1c; color:#fff; }
.container { min-height:100%; display:flex; flex-direction:column; justify-content:flex-start; }
.tab-content .card { margin-bottom:1rem; background:#2c2c2c; color:#fff; }
.img-preview { width:120px; height:120px; object-fit:cover; border-radius:50%; border:3px solid #e67e22; cursor:pointer; }
.btn-primary { background:#e67e22; border:none; }
.btn-primary:hover { background:#d35400; }
.btn-success { background:#27ae60; border:none; }
.btn-success:hover { background:#1e8449; }
.btn-warning { background:#c0392b; border:none; }
.btn-warning:hover { background:#922b21; }
.btn-outline-secondary { border-color:#e67e22; color:#e67e22; }
.btn-outline-secondary:hover { background:#e67e22; color:#fff; }
input, select, textarea { background:#3a3a3a; color:#fff; border:1px solid #555; }
input:disabled, select:disabled, textarea:disabled { background:#2c2c2c; color:#ccc; }
.nav-tabs .nav-link.active { background:#e67e22; color:#fff; }
.nav-tabs .nav-link { color:#ddd; }
</style>
</head>
<body>
<main class="container mt-3 flex-grow-1">
<h2 class="mb-4">Mi Perfil</h2>
<ul class="nav nav-tabs mb-3" id="perfilTabs" role="tablist">
<li class="nav-item" role="presentation"><button class="nav-link active" id="tab-perfil" data-bs-toggle="tab" data-bs-target="#perfilTab" type="button" role="tab">Perfil</button></li>
</ul>
<div class="tab-content flex-grow-1" id="perfilTabsContent">
<div class="tab-pane fade show active" id="perfilTab" role="tabpanel">
<div class="card p-4 w-100">
<form id="formPerfil" enctype="multipart/form-data">
<div class="d-flex flex-column align-items-center mb-3 position-relative">
<img id="previewImagen" src="{{ user.imagen_url or '/static/uploads/default_icon_profile.png' }}" class="img-preview rounded-circle">
<input type="file" id="imagen_url" name="imagen_url" accept="image/*" style="display:none">
</div>
<input type="text" id="cedulaPerfil" name="cedulaPerfil" class="form-control mb-2" placeholder="Cédula" value="{{ user.cedula or '' }}" required disabled>
<input type="text" id="nombrePerfil" name="nombrePerfil" class="form-control mb-2" placeholder="Nombre" value="{{ user.nombre or '' }}" disabled>
<input type="text" id="apellidoPerfil" name="apellidoPerfil" class="form-control mb-2" placeholder="Apellido" value="{{ user.apellido or '' }}" disabled>
<input type="text" id="telefonoPerfil" name="telefonoPerfil" class="form-control mb-2" placeholder="Teléfono" value="{{ user.telefono or '' }}" disabled>
<input type="email" id="correoPerfil" name="correoPerfil" class="form-control mb-2" placeholder="Correo" value="{{ user.correo or '' }}" required disabled>
<textarea id="direccionPerfil" name="direccionPerfil" class="form-control mb-2" placeholder="Dirección" rows="2" required disabled>{{ user.direccion or '' }}</textarea>
<select id="metodoPagoPerfil" name="metodoPagoPerfil" class="form-select mb-2" required disabled>
<option value="">Seleccione método de pago</option>
<option value="Efectivo" {% if user.metodo_pago=='Efectivo' %}selected{% endif %}>Efectivo</option>
<option value="Transferencia" {% if user.metodo_pago=='Transferencia' %}selected{% endif %}>Transferencia</option>
<option value="Tarjeta" {% if user.metodo_pago=='Tarjeta' %}selected{% endif %}>Tarjeta</option>
</select>
<div class="d-flex justify-content-between mt-3">
<button type="button" class="btn btn-primary" id="btnEditarPerfil">Actualizar Datos</button>
<button type="submit" class="btn btn-success" id="btnGuardarPerfil" style="display:none">Guardar Datos</button>
</div>
<div class="mt-3">
<input type="password" id="nuevaContrasena" class="form-control mb-2" placeholder="Nueva contraseña">
<button type="button" class="btn btn-warning" id="btnCambiarContrasena">Cambiar Contraseña</button>
</div>
</form>
</div>
</div>
</div>
</main>
{% include 'footer.html' %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const btnEditar = document.getElementById('btnEditarPerfil');
const btnGuardar = document.getElementById('btnGuardarPerfil');
const formPerfil = document.getElementById('formPerfil');
const inputs = formPerfil.querySelectorAll('input:not([type=file]), select, textarea');
const imagenInput = document.getElementById('imagen_url');
const previewImg = document.getElementById('previewImagen');
previewImg.addEventListener('click',()=>imagenInput.click());
imagenInput.addEventListener('change', e=>{
    if(e.target.files && e.target.files[0]){
        const reader = new FileReader();
        reader.onload = ev=>{ previewImg.src = ev.target.result; }
        reader.readAsDataURL(e.target.files[0]);
    }
});
btnEditar.addEventListener('click', ()=>{
    inputs.forEach(i=>i.disabled=false);
    btnEditar.style.display='none';
    btnGuardar.style.display='inline-block';
});
formPerfil.addEventListener('submit', async e=>{
    e.preventDefault();
    const formData = new FormData(formPerfil);
    const jsonData = {};
    formData.forEach((v,k)=>{ if(k!=='imagen_url') jsonData[k]=v; });
    try{
        const res = await fetch('/api/usuario/actualizar_completo', {
            method:'POST',
            body:formData
        });
        const result = await res.json();
        if(result.success){
            alert('Perfil actualizado correctamente');
            inputs.forEach(i=>i.disabled=true);
            btnGuardar.style.display='none';
            btnEditar.style.display='inline-block';
            previewImg.src = result.user.imagen_url || '/static/uploads/default_icon_profile.png';
        } else alert('Error al actualizar perfil');
    }catch(err){ console.error(err); alert('Error en la solicitud'); }
});
document.getElementById('btnCambiarContrasena').addEventListener('click', async ()=>{
    const nueva = document.getElementById('nuevaContrasena').value;
    if(!nueva){ alert('Ingrese una nueva contraseña'); return; }
    try{
        const res = await fetch('/api/usuario/cambiar_contrasena',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contrasena:nueva})
        });
        const result = await res.json();
        if(result.success){ alert('Contraseña cambiada correctamente'); document.getElementById('nuevaContrasena').value=''; }
        else alert('Error al cambiar la contraseña');
    }catch(err){ console.error(err); alert('Error en la solicitud'); }
});
</script>
</body>
</html>
