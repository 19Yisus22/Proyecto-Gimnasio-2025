<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Análisis y Reportes | Administración</title>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/icon.png') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_admin/style_analisis_reportes.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>const ID_USUARIO="{{ session['user']['id_usuario'] if session.get('user') else '' }}";</script>
</head>

<body>

{% include 'navbar.html' %}

<div class="container-central">

  <div class="card-title-center mb-4">Análisis y Reportes</div>

  <div class="row g-3 mb-4">
    <div class="col-lg-4 col-md-6">
      <div class="card shadow p-3 text-center kpi-box">
        <h6>Membresías Activas</h6>
        <h2 id="kpi_membresias">0</h2>
      </div>
    </div>

    <div class="col-lg-4 col-md-6">
      <div class="card shadow p-3 text-center kpi-box">
        <h6>Asistencia Promedio</h6>
        <h2 id="kpi_asistencia">0%</h2>
      </div>
    </div>

    <div class="col-lg-4 col-md-6">
      <div class="card shadow p-3 text-center kpi-box">
        <h6>Ingresos Totales</h6>
        <h2 id="kpi_ingresos">$0</h2>
      </div>
    </div>
  </div>

  <div class="main-container">

    <div class="row mb-4 g-3">
      <div class="col-md-3">
        <input type="text" id="buscarCedula" class="form-control" placeholder="Buscar por cédula">
      </div>

      <div class="col-md-2">
        <button class="btn btn-secondary w-100" onclick="filtrarPorCedula()">Buscar</button>
      </div>

      <div class="col-md-3">
        <select id="filtroReporte" class="form-select">
          <option value="asistencia">Asistencia</option>
          <option value="ingresos">Ingresos</option>
          <option value="nutricion">Planes Nutricionales</option>
          <option value="spa">Servicios de Spa</option>
        </select>
      </div>
    </div>

    <div id="usuariosList" class="d-flex flex-wrap"></div>

    <div id="usuarioDetalle" class="detalle-card p-3 mt-3" style="display:none;">
      <div class="d-flex align-items-start mb-2">
        <img id="fotoDetalle" src="" alt="Foto Usuario">
        <div class="ms-3 text-start">
          <h5 id="nombreDetalle"></h5>
          <p id="telefonoDetalle"></p>
          <p id="correoDetalle"></p>
          <p id="direccionDetalle"></p>
        </div>
      </div>
    </div>

    <div class="chart-container mt-4 p-3">
      <canvas id="chartReporte" height="200"></canvas>
    </div>

    <div class="table-responsive mt-4">
      <table id="tablaReporte" class="table table-striped table-bordered reporte-table">
        <thead>
          <tr>
            <th style="color: black;">Datos</th>
            <th style="color: black;">Valores</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

{% include 'footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/funtions_admin/analisis_reportes.js') }}"></script>
<script>
let chart;
let usuario = null;
let usuarios = [];

function cargarKpis() {
  fetch('/reportes/kpis')
    .then(r => r.json())
    .then(d => {
      document.getElementById('kpi_membresias').innerText = d.membresias;
      document.getElementById('kpi_asistencia').innerText = d.asistencia + '%';
      document.getElementById('kpi_ingresos').innerText = '$' + d.ingresos;
    });
}

function cargarUsuarios() {
  fetch('/usuarios/listar?roles=miembro')
    .then(r => r.json())
    .then(d => {
      usuarios = d;
      mostrarUsuarios(d);
      actualizarGraficaGeneral();
    });
}

function mostrarUsuarios(lista) {
  const cont = document.getElementById('usuariosList');
  cont.innerHTML = '';
  lista.forEach(u => {
    const card = document.createElement('div');
    card.className = 'usuario-card';
    card.innerHTML = `<img src="${u.imagen_url || '/static/default.png'}"><span>${u.nombre} ${u.apellido}</span>`;
    card.onclick = () => seleccionarUsuario(u, card);
    cont.appendChild(card);
  });
}

function seleccionarUsuario(u, card) {
  usuario = u;
  document.querySelectorAll('.usuario-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  mostrarDetalle(u);
  actualizarGrafica();
}

function mostrarDetalle(u) {
  document.getElementById('usuarioDetalle').style.display = 'block';
  document.getElementById('fotoDetalle').src = u.imagen_url || '/static/default.png';
  document.getElementById('nombreDetalle').innerText = u.nombre + ' ' + u.apellido;
  document.getElementById('telefonoDetalle').innerText = 'Tel: ' + (u.telefono || '-');
  document.getElementById('correoDetalle').innerText = 'Correo: ' + (u.correo || '-');
  document.getElementById('direccionDetalle').innerText = 'Dirección: ' + (u.direccion || '-');
}

document.getElementById('filtroReporte').addEventListener('change', () => {
  if (usuario) actualizarGrafica();
  else actualizarGraficaGeneral();
});

function filtrarPorCedula() {
  const cedula = document.getElementById('buscarCedula').value.trim();
  if (cedula === '') return mostrarUsuarios(usuarios);
  const filtrados = usuarios.filter(u => u.cedula.includes(cedula));
  mostrarUsuarios(filtrados);
}

function actualizarGraficaGeneral() {
  const tipo = document.getElementById('filtroReporte').value;
  fetch(`/api/admin/reportes_data?tipo=${tipo}`)
    .then(r => r.json())
    .then(data => renderizarGrafica(data));
}

function actualizarGrafica() {
  const tipo = document.getElementById('filtroReporte').value;
  fetch(`/api/admin/reportes_data?tipo=${tipo}&cedula=${usuario.cedula}`)
    .then(r => r.json())
    .then(data => renderizarGrafica(data));
}

function renderizarGrafica(data) {
  const ctx = document.getElementById('chartReporte').getContext('2d');
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: '',
        data: data.valores,
        fill: false,
        borderColor: 'rgba(54, 162, 235, 0.8)',
        tension: 0.3
      }]
    },
    options: { responsive: true }
  });

  const tbody = document.querySelector('#tablaReporte tbody');
  tbody.innerHTML = '';

  Object.entries(data.detalles[0]).forEach(([k, v]) => {
    tbody.innerHTML += `
      <tr>
        <td style="color: black;">${k}</td>
        <td style="color: black;">${v}</td>
      </tr>
    `;
  });
}

window.onload = () => {
  cargarKpis();
  cargarUsuarios();
};

</script>
</body>
</html>