<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soporte y Comunidad | GymApp</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/icon.png') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_soporte.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
html, body { height:100%; }
body { display:flex; flex-direction:column; }
#chatSoporte { height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 10px; }
.msg { display: flex; margin-bottom: 8px; }
.msg.admin { justify-content: flex-end; }
.bubble { padding: 8px 12px; border-radius: 15px; max-width: 70%; display: inline-block; }
.bubble.user { background: #0d6efd; color: white; }
.bubble.admin { background: #e9ecef; color: #000; }
.footer-container { margin-top:auto; background-color:#343a40; color:#f8f9fa; }
.footer-section a.btn-outline-light { transition: all 0.3s ease; }
.footer-section a.btn-outline-light:hover { background-color:#0d6efd; border-color:#0d6efd; color:#fff; }
</style>
</head>
<body class="d-flex flex-column min-vh-100">

{% include 'navbar.html' %}

<main class="container my-4 flex-grow-1">
  <h2 class="text-center mb-4">Comunidad y Soporte</h2>

  <ul class="nav nav-tabs mb-3" id="comunidadTabs" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="foro-tab" data-bs-toggle="tab" data-bs-target="#foroTab">Foro</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="grupos-tab" data-bs-toggle="tab" data-bs-target="#gruposTab">Grupos</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="eventos-tab" data-bs-toggle="tab" data-bs-target="#eventosTab">Eventos</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tickets-tab" data-bs-toggle="tab" data-bs-target="#ticketsTab">Tickets</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chatTab">Chat</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="foroTab">
      <div class="card mb-3">
        <div class="card-body">
          <textarea id="nuevaPublicacion" class="form-control mb-2" placeholder="Comparte algo con la comunidad..."></textarea>
          <button class="btn btn-primary w-100" onclick="crearPublicacion()">Publicar</button>
        </div>
      </div>
      <div id="foro"><p class="text-muted">Cargando publicaciones...</p></div>
    </div>

    <div class="tab-pane fade" id="gruposTab"><div id="grupos" class="row"><p class="text-muted">Cargando grupos...</p></div></div>

    <div class="tab-pane fade" id="eventosTab"><div id="eventos" class="row"><p class="text-muted">Cargando eventos...</p></div></div>

    <div class="tab-pane fade" id="ticketsTab">
      <div class="card mb-3">
        <div class="card-body">
          <select id="categoriaTicket" class="form-select mb-2">
            <option value="">Seleccione categoría</option>
            <option value="Membresía">Membresía</option>
            <option value="Clases">Clases</option>
            <option value="Pagos">Pagos</option>
            <option value="App">App</option>
          </select>
          <textarea id="descripcionTicket" class="form-control mb-2" placeholder="Describa el problema..."></textarea>
          <button class="btn btn-success w-100" onclick="enviarTicket()">Enviar Ticket</button>
        </div>
      </div>
      <table class="table table-striped">
        <thead class="table-dark">
          <tr><th>ID</th><th>Categoría</th><th>Estado</th><th>Respuesta</th></tr>
        </thead>
        <tbody id="tablaTickets"></tbody>
      </table>
    </div>

    <div class="tab-pane fade" id="chatTab">
      <div id="chatSoporte"></div>
      <div class="d-flex gap-2 mt-2">
        <textarea id="mensajeSoporte" class="form-control" placeholder="Escribe al soporte..."></textarea>
        <button class="btn btn-primary" onclick="enviarMensajeSoporte()">Enviar</button>
      </div>
    </div>
  </div>
</main>

<div class="footer-container mt-auto">
  <footer class="footer py-4">
    <div class="container d-flex flex-column flex-md-row flex-wrap justify-content-between align-items-start">
      <div class="footer-section mb-3 mb-md-0">
        <h5 class="mb-3">Contáctanos</h5>
        <div class="mb-1"><i class="bi bi-person-fill me-2"></i>Gimnasio y Centro de Fitness</div>
        <div class="mb-1"><i class="bi bi-telephone-fill me-2"></i>Teléfono: +57 XXXXXXXXXX</div>
        <div class="mb-1"><i class="bi bi-envelope-fill me-2"></i>Correo: gimnasio_fitness@gmail.com</div>
        <div class="mb-1"><i class="bi bi-geo-alt-fill me-2"></i>Dirección: Carrera X #00, Ciudad XXXX</div>
        <div class="mb-1"><i class="bi bi-clock-fill me-2"></i>Horarios: 6:00 - 22:00</div>
      </div>
      <div class="footer-section mb-3 mb-md-0">
        <h5 class="mb-3">Síguenos en:</h5>
        <a href="https://www.instagram.com" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-instagram"></i></a>
        <a href="https://www.facebook.com" class="btn btn-outline-light btn-sm"><i class="bi bi-facebook"></i></a>
      </div>
      <div class="footer-section text-center">
        <h5 class="mb-3">Gimnasio | Centro Fitness</h5>
        <a href="/inicio"><img src="{{ url_for('static', filename='uploads/icon.png') }}" alt="icon" class="img-fluid" style="max-width:100px;"></a>
      </div>
    </div>
    <div class="text-center mt-4 border-top border-secondary pt-3">
      <p class="mb-0">Gimnasio y Centro de Fitness 2025 © | Todos los derechos reservados</p>
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const ws = new WebSocket("ws://localhost:8000/ws");

ws.onmessage = function(event) {
  const data = JSON.parse(event.data);
  if (data.tipo === "chat") actualizarChat(data);
  if (data.tipo === "publicacion") cargarForo();
};

function actualizarChat(msg) {
  const cont = document.getElementById('chatSoporte');
  const div = document.createElement('div');
  div.className = `msg ${msg.rol === 'admin' ? 'admin' : 'user'}`;
  div.innerHTML = `<div class="bubble ${msg.rol === 'admin' ? 'admin' : 'user'}">${msg.mensaje}</div>`;
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
}

async function enviarMensajeSoporte() {
  const msg = document.getElementById('mensajeSoporte').value;
  if (!msg) return;
  ws.send(JSON.stringify({ tipo: 'chat', mensaje: msg }));
  document.getElementById('mensajeSoporte').value = '';
}

async function cargarForo() {
  try {
    const r = await fetch('/api/comunidad/publicaciones');
    const d = await r.json();
    const cont = document.getElementById('foro');
    cont.innerHTML = '';
    if (!d.length) { cont.innerHTML = '<p class="text-muted">No hay publicaciones todavía.</p>'; return; }
    d.forEach(p => {
      const div = document.createElement('div');
      div.className = 'card mb-3';
      div.innerHTML = `<div class="card-body"><h6>${p.usuario || "Usuario"}</h6><p>${p.texto}</p></div>`;
      cont.appendChild(div);
    });
  } catch { console.warn('Error cargando publicaciones'); }
}

async function crearPublicacion() {
  const t = document.getElementById('nuevaPublicacion').value;
  if (!t) return;
  await fetch('/api/comunidad/publicar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ texto: t })
  });
  document.getElementById('nuevaPublicacion').value = '';
  cargarForo();
}

async function cargarGrupos() {
  const r = await fetch('/api/grupos');
  const d = await r.json();
  const g = document.getElementById('grupos');
  g.innerHTML = '';
  if (!d.length) { g.innerHTML = '<p class="text-muted">No hay grupos disponibles.</p>'; return; }
  d.forEach(i => {
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-3';
    col.innerHTML = `<div class="card h-100 text-center"><div class="card-body"><h5>${i.nombre}</h5><p>${i.descripcion}</p><button class="btn btn-outline-primary w-100" onclick="unirseGrupo(${i.id})">Unirse</button></div></div>`;
    g.appendChild(col);
  });
}
async function unirseGrupo(id) { await fetch(`/api/grupos/${id}/unirse`, { method: 'POST' }); cargarGrupos(); }

async function cargarEventos() {
  const r = await fetch('/api/eventos');
  const d = await r.json();
  const e = document.getElementById('eventos');
  e.innerHTML = '';
  if (!d.length) { e.innerHTML = '<p class="text-muted">No hay eventos disponibles.</p>'; return; }
  d.forEach(ev => {
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-3';
    col.innerHTML = `<div class="card h-100"><div class="card-body"><h5>${ev.nombre}</h5><p>${ev.descripcion}</p><p><strong>${ev.fecha}</strong></p><button class="btn btn-outline-success w-100" onclick="inscribirseEvento(${ev.id})">Inscribirse</button></div></div>`;
    e.appendChild(col);
  });
}
async function inscribirseEvento(id) { await fetch(`/api/eventos/${id}/inscribirse`, { method: 'POST' }); cargarEventos(); }

async function cargarTickets() {
  let tickets = [];
  try {
    const r = await fetch('/api/soporte/tickets');
    tickets = await r.json();
  } catch { console.warn('No se pudo cargar tickets'); }

  const t = document.getElementById('tablaTickets');
  t.innerHTML = '';

  if (!tickets.length) {
    tickets = [
      { id: 1, categoria: 'Membresía', estado: 'Pendiente', respuesta: '' },
      { id: 2, categoria: 'App', estado: 'Resuelto', respuesta: 'Actualice la aplicación' }
    ];
  }

  tickets.forEach(x => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.id}</td><td>${x.categoria}</td><td>${x.estado}</td><td>${x.respuesta || '-'}</td>`;
    t.appendChild(tr);
  });
}

async function enviarTicket() {
  const cat = document.getElementById('categoriaTicket').value;
  const desc = document.getElementById('descripcionTicket').value;
  if (!cat || !desc) return;
  await fetch('/api/soporte/ticket', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ categoria: cat, descripcion: desc })
  });
  document.getElementById('categoriaTicket').value = '';
  document.getElementById('descripcionTicket').value = '';
  cargarTickets();
}

window.onload = () => {
  cargarForo();
  cargarGrupos();
  cargarEventos();
  cargarTickets();
};
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>