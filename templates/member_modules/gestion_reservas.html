<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestión Clases | Miembros</title>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/icon.png') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
#toastContainer { z-index:1055; }
.progress { height:25px; margin-bottom:15px; }
.star-rating .bi-star { cursor:pointer; color:gray; }
.star-rating .bi-star-fill { color:gold; }
.table-pagination { display:flex; justify-content:center; margin-top:10px; gap:5px; }
.table-pagination button { min-width:35px; }
</style>
</head>
<body>
{% include 'navbar.html' %}
<div class="container mt-4" style="margin-left:250px;">
  <h2 class="mb-4 text-center">Clases y Reservas</h2>
  <div class="d-flex gap-2 mb-3 flex-wrap">
    <input type="text" id="buscarClase" class="form-control" placeholder="Buscar por disciplina o entrenador">
    <select id="filtroDisciplina" class="form-select w-auto"><option value="Todos">Todas</option></select>
    <select id="filtroHorario" class="form-select w-auto">
      <option value="Todos">Todos los horarios</option>
      <option value="Mañana">Mañana</option>
      <option value="Tarde">Tarde</option>
      <option value="Noche">Noche</option>
    </select>
    <button id="actualizarCalendario" class="btn btn-primary"><i class="bi bi-arrow-repeat"></i> Actualizar</button>
  </div>

  <div class="table-responsive mb-2">
    <table class="table table-bordered align-middle text-center">
      <thead>
        <tr>
          <th>Disciplina</th>
          <th>Entrenador</th>
          <th>Horario</th>
          <th>Cupos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaClases"></tbody>
    </table>
    <div id="paginacionClases" class="table-pagination"></div>
  </div>

  <h3>Mis Reservas</h3>
  <div class="table-responsive mb-2">
    <table class="table table-bordered text-center">
      <thead>
        <tr>
          <th>Disciplina</th>
          <th>Entrenador</th>
          <th>Horario</th>
          <th>Acciones</th>
          <th>Feedback Clase</th>
        </tr>
      </thead>
      <tbody id="misReservas"></tbody>
    </table>
    <div id="paginacionReservas" class="table-pagination"></div>
  </div>

  <h5>Progreso de Reservas</h5>
  <div class="progress mb-4">
    <div id="barraProgreso" class="progress-bar" role="progressbar" style="width:0%">0%</div>
  </div>

  <h3 class="mt-5">Feedback al Entrenador</h3>
  <div class="card mb-4 p-3">
    <div class="mb-3">
      <label>Selecciona Entrenador</label>
      <select id="feedbackEntrenadorMiembro" class="form-select"><option value="" disabled selected>Seleccione un entrenador</option></select>
    </div>
    <div class="mb-3">
      <label>Mensaje</label>
      <textarea id="feedbackMensajeMiembro" class="form-control" rows="3"></textarea>
    </div>
    <div class="mb-3 star-rating">
      <label>Calificación</label><br>
      <i class="bi bi-star" data-value="1"></i>
      <i class="bi bi-star" data-value="2"></i>
      <i class="bi bi-star" data-value="3"></i>
      <i class="bi bi-star" data-value="4"></i>
      <i class="bi bi-star" data-value="5"></i>
    </div>
    <button class="btn btn-primary" id="btnEnviarFeedbackMiembro">Enviar Feedback</button>
  </div>

  <div class="modal fade" id="modalFeedback" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enviar Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="feedbackClaseId">
          <div class="mb-3">
            <label>Mensaje</label>
            <textarea id="feedbackMensaje" class="form-control" rows="3"></textarea>
          </div>
          <div class="mb-3 star-rating">
            <label>Calificación</label><br>
            <i class="bi bi-star" data-value="1"></i>
            <i class="bi bi-star" data-value="2"></i>
            <i class="bi bi-star" data-value="3"></i>
            <i class="bi bi-star" data-value="4"></i>
            <i class="bi bi-star" data-value="5"></i>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnEnviarFeedback">Enviar</button>
        </div>
      </div>
    </div>
  </div>

</div>

<div id="toastContainer" class="position-fixed p-3 top-0 end-0"></div>

{% include 'footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/funtions_member/gestion_clases_reservas.js') }}"></script>
<script>

  document.addEventListener("DOMContentLoaded", ()=>{
  const tablaClases=document.getElementById("tablaClases");
  const misReservas=document.getElementById("misReservas");
  const buscar=document.getElementById("buscarClase");
  const filtroDisciplina=document.getElementById("filtroDisciplina");
  const filtroHorario=document.getElementById("filtroHorario");
  const btnActualizar=document.getElementById("actualizarCalendario");
  const barraProgreso=document.getElementById("barraProgreso");
  const toastContainer=document.getElementById("toastContainer");
  const selectMiembro=document.getElementById("feedbackEntrenadorMiembro");
  let reservasUsuario=[], calificacionClase=0, calificacionMiembro=0;
  let paginaClases=1, paginaReservas=1, filasPorPagina=5;
  let todasClases=[], todasReservas=[];

  function mostrarToast(msg,tipo="success"){
    const color=tipo==="error"?"bg-danger":"bg-success";
    const toast=document.createElement("div");
    toast.className=`toast align-items-center text-white ${color} border-0 show`;
    toast.role="alert";
    toast.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    toastContainer.appendChild(toast);
    setTimeout(()=>toast.remove(),3000);
  }

  async function cargarFiltros(){
    try{
      const res=await fetch("/api/miembros/reservas");
      const data=await res.json();
      if(!data.ok) return;
      const disciplinas=[...new Set(data.clases.map(c=>c.tipo_clase))];
      filtroDisciplina.innerHTML=`<option value="Todos">Todas</option>`+disciplinas.map(d=>`<option value="${d}">${d}</option>`).join('');
    }catch{}
  }

  async function cargarClases(){
    try{
      const res=await fetch("/api/miembros/reservas");
      const data=await res.json();
      if(!data.ok) throw new Error();
      todasClases=data.clases.filter(c=>!reservasUsuario.includes(c.id_clase));
      renderClases();
    }catch{mostrarToast("Error al cargar clases","error");}
  }

  function renderClases(){
    tablaClases.innerHTML="";
    const texto=buscar.value.toLowerCase(), disciplina=filtroDisciplina.value;
    const clasesFiltradas=todasClases.filter(c=>
      (c.tipo_clase?.toLowerCase().includes(texto) || c.instructor?.toLowerCase().includes(texto)) &&
      (disciplina==="Todos"||c.tipo_clase===disciplina)
    );
    const totalPaginas=Math.ceil(clasesFiltradas.length/filasPorPagina);
    if(paginaClases>totalPaginas) paginaClases=totalPaginas || 1;
    const inicio=(paginaClases-1)*filasPorPagina;
    const fragment=document.createDocumentFragment();
    clasesFiltradas.slice(inicio,inicio+filasPorPagina).forEach(c=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${c.tipo_clase}</td><td>${c.instructor||"Sin asignar"}</td><td>${c.horario}</td><td>${c.cupos_disponibles}</td>
      <td><button class="btn btn-success btn-sm" onclick="reservarClase('${c.id_clase}','${c.instructor_id}')"><i class="bi bi-calendar-plus"></i> Reservar</button></td>`;
      fragment.appendChild(tr);
    });
    if(!fragment.children.length) tablaClases.innerHTML=`<tr><td colspan="5">No hay clases disponibles</td></tr>`;
    else tablaClases.appendChild(fragment);
    renderPaginacion('paginacionClases', totalPaginas, paginaClases, (p)=>{paginaClases=p; renderClases();});
  }

  async function cargarMisReservas(){
    try{
      const res=await fetch("/api/miembros/mis_reservas");
      const data=await res.json();
      if(!data.ok) return;
      todasReservas=data.clases;
      reservasUsuario=data.clases.map(c=>c.id_clase);
      const entrenadores={};
      todasReservas.forEach(c=>{ if(c.instructor?.trim()!=="") entrenadores[c.instructor_id]=c.instructor; });
      selectMiembro.innerHTML='<option value="" disabled selected>Seleccione un entrenador</option>';
      for(const [id,nombre] of Object.entries(entrenadores)){
        const option=document.createElement("option");
        option.value=id; option.text=nombre; selectMiembro.appendChild(option);
      }
      renderReservas();
    }catch{mostrarToast("Error al cargar tus reservas","error");}
  }

  function renderReservas(){
    misReservas.innerHTML="";
    const totalPaginas=Math.ceil(todasReservas.length/filasPorPagina);
    if(paginaReservas>totalPaginas) paginaReservas=totalPaginas || 1;
    const inicio=(paginaReservas-1)*filasPorPagina;
    const fragment=document.createDocumentFragment();
    todasReservas.slice(inicio,inicio+filasPorPagina).forEach(c=>{
      const completada=c.estado==="completada" || c.estado==="cancelada";
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${c.tipo_clase}</td><td>${c.instructor}</td><td>${c.horario}</td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="cancelarReserva('${c.id_reserva}')" ${completada?'disabled':''}>Cancelar</button>
          <button class="btn btn-success btn-sm" onclick="completarReserva('${c.id_reserva}')" ${completada?'disabled':''}>Completar</button>
          ${completada?`<button class="btn btn-danger btn-sm" onclick="eliminarReserva('${c.id_reserva}')">Eliminar</button>`:''}
        </td>
        <td><button class="btn btn-primary btn-sm" onclick="abrirFeedback('${c.id_clase}')">Feedback</button></td>`;
      fragment.appendChild(tr);
    });
    misReservas.appendChild(fragment);
    actualizarProgreso(todasReservas.length, todasReservas.filter(c=>c.estado==="completada").length);
    renderPaginacion('paginacionReservas', totalPaginas, paginaReservas, (p)=>{paginaReservas=p; renderReservas();});
  }

  function renderPaginacion(idContainer, totalPaginas, paginaActual, callback){
    const cont=document.getElementById(idContainer);
    cont.innerHTML="";
    for(let i=1;i<=totalPaginas;i++){
      const btn=document.createElement("button");
      btn.className=`btn ${i===paginaActual?'btn-primary':'btn-outline-primary'}`;
      btn.textContent=i;
      btn.addEventListener("click",()=>callback(i));
      cont.appendChild(btn);
    }
  }

  function actualizarProgreso(total, completadas){
    const pct=total>0?Math.round(completadas/total*100):0;
    barraProgreso.style.width=pct+"%";
    barraProgreso.textContent=pct+"%";
  }

  window.abrirFeedback=function(idClase){
    document.getElementById("feedbackClaseId").value=idClase;
    document.getElementById("feedbackMensaje").value="";
    calificacionClase=0;
    document.querySelectorAll("#modalFeedback .star-rating .bi").forEach(s=>s.className="bi bi-star");
    new bootstrap.Modal(document.getElementById("modalFeedback")).show();
  }

  document.querySelectorAll(".star-rating .bi").forEach(star=>{
    star.addEventListener("click",()=>{
      const parent=star.closest(".star-rating");
      if(parent.closest(".card")){
        calificacionMiembro=parseInt(star.dataset.value);
        parent.querySelectorAll(".bi").forEach(s=>s.className=s.dataset.value<=calificacionMiembro?"bi bi-star-fill":"bi bi-star");
      } else {
        calificacionClase=parseInt(star.dataset.value);
        parent.querySelectorAll(".bi").forEach(s=>s.className=s.dataset.value<=calificacionClase?"bi bi-star-fill":"bi bi-star");
      }
    });
  });

  document.getElementById("btnEnviarFeedbackMiembro").addEventListener("click",async ()=>{
    const mensaje=document.getElementById("feedbackMensajeMiembro").value.trim();
    const idEntrenador=selectMiembro.value;
    if(!idEntrenador){mostrarToast("Seleccione un entrenador","error"); return;}
    if(!mensaje){mostrarToast("Ingrese un mensaje","error"); return;}
    const res=await fetch("/api/miembros/feedback_entrenador",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_entrenador:idEntrenador,mensaje,calificacion:calificacionMiembro})});
    const data=await res.json();
    if(data.ok){mostrarToast("Feedback enviado"); document.getElementById("feedbackMensajeMiembro").value=""; calificacionMiembro=0; document.querySelectorAll(".card .star-rating .bi").forEach(s=>s.className="bi bi-star");}
    else mostrarToast(data.message||"Error al enviar feedback","error");
  });

  document.getElementById("btnEnviarFeedback").addEventListener("click",async ()=>{
    const mensaje=document.getElementById("feedbackMensaje").value.trim();
    if(!mensaje){mostrarToast("Ingrese un mensaje","error"); return;}
    const idClase=document.getElementById("feedbackClaseId").value;
    const res=await fetch("/api/miembros/feedback_clase",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_clase:idClase,mensaje,calificacion:calificacionClase})});
    const data=await res.json();
    if(data.ok){mostrarToast("Feedback enviado"); bootstrap.Modal.getInstance(document.getElementById("modalFeedback")).hide(); }
    else mostrarToast(data.message||"Error al enviar feedback","error");
  });

  window.reservarClase=async function(idClase){
    const res=await fetch("/api/miembros/crear_reservas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_clase:idClase})});
    const data=await res.json();
    if(!data.ok){mostrarToast(data.message||"Error al reservar","error"); return;}
    mostrarToast("Reserva realizada");
    await cargarClases();
    await cargarMisReservas();
  }

  window.cancelarReserva=async function(id){
    const res=await fetch(`/api/miembros/cancelar_reservas/${id}`,{method:"PUT"});
    const data=await res.json();
    if(!data.ok){mostrarToast(data.message||"Error al cancelar","error"); return;}
    mostrarToast("Reserva cancelada");
    await cargarClases();
    await cargarMisReservas();
  }

  window.completarReserva=async function(id){
    const res=await fetch(`/api/miembros/completar_reservas/${id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({estado:"completada"})});
    const data=await res.json();
    if(!data.ok){mostrarToast(data.message||"Error al completar","error"); return;}
    mostrarToast("Reserva marcada como completada");
    await cargarClases();
    await cargarMisReservas();
  }

  window.eliminarReserva=async function(id){
    const res=await fetch(`/api/miembros/eliminar_reserva/${id}`,{method:"DELETE"});
    const data=await res.json();
    if(!data.ok){mostrarToast(data.message||"Error al eliminar","error"); return;}
    mostrarToast("Reserva eliminada");
    paginaReservas=1;
    await cargarClases();
    await cargarMisReservas();
  }

  buscar.addEventListener("input",renderClases);
  filtroDisciplina.addEventListener("change",renderClases);
  filtroHorario.addEventListener("change",renderClases);
  btnActualizar.addEventListener("click",()=>{cargarClases();cargarMisReservas();});

  cargarFiltros(); cargarClases(); cargarMisReservas();
});
</script>
</body>
</html>
